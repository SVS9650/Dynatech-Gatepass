<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DYNATECH CONTROLS - Gate Pass</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center">

    <div class="w-full max-w-md bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center border-b-2 border-blue-500 pb-3">
            DYNATECH GATE PASS
        </h1>
        <p class="text-center text-sm text-gray-500">
            Please fill in your details to submit a new Gate Pass request.
        </p>

        <!-- Form Fields -->
        <form id="gatePassForm" class="space-y-4">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                <input type="text" id="name" required placeholder="Your full name"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
            </div>

            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                <input type="text" id="department" required placeholder="e.g., Production, HR, Sales"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
            </div>

            <div>
                <label for="user_email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input type="email" id="user_email" required placeholder="Your corporate email"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
            </div>
            
            <div>
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Pass</label>
                <textarea id="reason" rows="3" required placeholder="Briefly explain why you need the gate pass"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm resize-none"></textarea>
            </div>

            <!-- Action Button -->
            <button type="submit" id="submitButton"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-green-300 flex items-center justify-center">
                <span id="buttonText">Submit Gate Pass</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>

        <!-- Message Box -->
        <div id="messageBox" class="hidden px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold message-title"></strong>
            <span class="block sm:inline message-body"></span>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // This URL targets your Flask server running locally on port 5000.
        const API_URL = 'http://127.0.0.1:5000/api/gatepass'; 
        
        // --- DOM Elements ---
        const form = document.getElementById('gatePassForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = messageBox.querySelector('.message-title');
        const messageBody = messageBox.querySelector('.message-body');

        // --- Event Listener ---
        form.addEventListener('submit', handleFormSubmit);

        // --- Core Logic ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            clearMessage();
            setLoading(true);

            // 1. Gather data from form inputs
            const payload = {
                name: document.getElementById('name').value.trim(),
                department: document.getElementById('department').value.trim(),
                reason: document.getElementById('reason').value.trim(),
                user_email: document.getElementById('user_email').value.trim()
            };

            try {
                // 2. Send data to the Flask API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    showMessage('Success!', result.message, 'success');
                    form.reset(); // Clear form on success
                } else if (response.ok && result.status === 'warning') {
                     // Data saved, but email failed (as handled in app.py)
                    showMessage('Warning!', result.message, 'warning');
                    form.reset();
                } else {
                    // Handle client-side (400) and server-side (500) errors
                    showMessage('Error!', result.message, 'error');
                }

            } catch (error) {
                console.error('Network or Parse Error:', error);
                showMessage('Network Error!', 'Could not connect to the server (is app.py running?). Please check your connection or contact IT.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // --- UI Utility Functions ---
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Submitting...' : 'Submit Gate Pass';
        }

        function clearMessage() {
            messageBox.classList.add('hidden');
            messageBox.className = "px-4 py-3 rounded-lg relative"; // Reset classes
        }

        function showMessage(title, body, type) {
            messageTitle.textContent = title;
            messageBody.textContent = body;
            messageBox.classList.remove('hidden');

            // Apply styling based on message type
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
            }
        }
    </script>
</body>
</html>
